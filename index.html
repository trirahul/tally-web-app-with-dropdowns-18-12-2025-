<!DOCTYPE html>

<html>

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Tally Retail Sale</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>

    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

</head>

<body>

    <div id="root"></div>

    <script type="text/babel">

function TallyRetailSaleForm() {

  const [serverUrl, setServerUrl] = React.useState('http://192.168.1.100:5000');

  const [companies, setCompanies] = React.useState([]);

  const [loadingCompanies, setLoadingCompanies] = React.useState(false);

  const [formData, setFormData] = React.useState({

    companyName: '',

    partyName: '',

    customerName: '',

    address: '',

    phone: '',

    date: new Date().toISOString().split('T')[0],

    items: [{ name: '', imei: '', quantity: 1, rate: 0, gstRate: 18, amount: 0 }]

  });

  const [status, setStatus] = React.useState({ type: '', message: '' });

  const [loading, setLoading] = React.useState(false);

  const [lastVoucherNumber, setLastVoucherNumber] = React.useState('');



  const partyLedgers = [

    'Bajaj Finance',

    'IDFC FRIST BANK LTD',

    'TVS CREDIT SERVICE LTD',

    'HDB FINANCE',

    'AMARAVATI',

    'Poonawalla Fincorp FINANCE A/C',

    'Cash',

    'Online Pay',

    'SWIPE',

    'New'

  ];



  const stockItems = [

    'DEMO PHONE',

    'Intex Feature Phone',

    'KARBON',

    'MICROMAX',

    'Nokia',

    'ONEPLUS PHONE',

    'Samsung',

    'A3X (4/128) - STARRY PURPLE',

    'APPLE IPHONE 15 BLUE (128GB)',

    'Apple iPhone 16 (128GB)',

    'Apple iPhone 17 (256GB)',

    'GOOGLE PIXEL 9A (8/256)(5G) Mobile',

    'Intex Mobile Aqua Lions T1plus -City',

    'I-Phone 15 128GB (Blue)',

    'IPHONE 16 128GB (WHITE)',

    'iQOO Z10 (8/256)',

    'iQOO Z9S 5G (8/256)',

    'Jio Phone 2403N',

    'M5 Spark Maxking',

    'Mmc Combo (8gb+4gb)',

    'MOTO E13 8/128',

    'Moto G35 4/128',

    'MOTOROLA G58 8/128',

    'MOTOROLA G85 12/256',

    'Narzo N65 4/128',

    'NOTHING 3A PRO MOBILE (8GB/256GB)',

    'Nothing CMF 2 Pro (8/128)(5G) Mobile',

    'Nothing Phone 2a 8/128GB',

    'Nothing Phone 2a 8/256 Black',

    'ONEPLUS T.V. 43"',

    'OPPO A3X 5G (6/128)',

    'OPPO A5 PRO 5G (8GB / 128GB)',

    'Oppo A6x (4/128)(5G) Mobile',

    'Oppo F31 Pro (8/128)(5G) Mobile',

    'Oppo F31 Pro (8/256)(5G) Mobile',

    'POCO X6 NEO 8/128',

    'REALME 14 PRO (8/128) HANDSET (S GREY)',

    'REALME C65 DUMMY BLACK/GREEN',

    'Realme C75 4/128',

    'Realme C75 6/128',

    'REALME C75 DUMMY GREEN',

    'REALME GIFT MOBILE STAND',

    'Realme Narzo 50 (4/64)',

    'REALME P2 PRO (8/256)',

    'Redmi 10 Power 8/128',

    'Redmi Mobile A5 4g 3/64',

    'SAMSUNG A55 5G 8/128',

    'Samsung F04 4/64',

    'SAMSUNG GALAXY S24 (5G)(8/256)',

    'SAMSUNG Z FLIP 5 8/256',

    'Tata Sky Evd',

    'VIVO V50 5G (8GB / 128GB)',

    'VIVO V50 5G (8GB / 256GB)',

    'VIVO V50 (8/256)',

    'VIVO V50 ELITE 12/512',

    'VIVO V60e (8/128)(5G) Mobile',

    'VIVO X300 (12/512)(5G) Mobile',

    'VIVO Y29 5G (4/128)',

    'VIVO Y29 5G (6/128)',

    'VIVO Y400 PRO (8/128) DEMO',

    'Y19 5G (4/128)'

  ];



  const fetchCompanies = async () => {

    setLoadingCompanies(true);

    try {

      const response = await fetch(`${serverUrl}/get-companies`);

      const result = await response.json();

      

      if (response.ok && result.companies) {

        setCompanies(result.companies);

        if (result.companies.length > 0) {

          setFormData({ ...formData, companyName: result.companies[0] });

        }

      } else {

        setStatus({ type: 'error', message: 'Failed to fetch companies' });

      }

    } catch (error) {

      setStatus({ type: 'error', message: 'Cannot connect to server' });

    } finally {

      setLoadingCompanies(false);

    }

  };



  const addItem = () => {

    setFormData({

      ...formData,

      items: [...formData.items, { name: '', imei: '', quantity: 1, rate: 0, gstRate: 18, amount: 0 }]

    });

  };



  const removeItem = (index) => {

    const newItems = formData.items.filter((_, i) => i !== index);

    setFormData({ ...formData, items: newItems });

  };



  const updateItem = (index, field, value) => {

    const newItems = [...formData.items];

    newItems[index][field] = value;

    

    if (field === 'quantity' || field === 'rate' || field === 'gstRate') {

      const qty = parseFloat(newItems[index].quantity) || 0;

      const rate = parseFloat(newItems[index].rate) || 0;

      

      newItems[index].amount = qty * rate;

    }

    

    setFormData({ ...formData, items: newItems });

  };



  const calculateTotals = () => {

    let subtotal = 0;

    let cgst = 0;

    let sgst = 0;

    

    formData.items.forEach(item => {

      const qty = parseFloat(item.quantity) || 0;

      const rate = parseFloat(item.rate) || 0;

      const gstRate = parseFloat(item.gstRate) || 0;

      

      const baseAmount = (qty * rate) / (1 + gstRate / 100);

      const gstAmount = (qty * rate) - baseAmount;

      

      subtotal += baseAmount;

      cgst += gstAmount / 2;

      sgst += gstAmount / 2;

    });

    

    const total = subtotal + cgst + sgst;

    const roundedTotal = Math.round(total);

    const roundOff = roundedTotal - total;

    

    return { subtotal, cgst, sgst, total, roundedTotal, roundOff };

  };



  const handleSubmit = async () => {

    if (!formData.companyName) {

      setStatus({ type: 'error', message: 'Please select a company' });

      return;

    }

    if (!formData.partyName || !formData.customerName) {

      setStatus({ type: 'error', message: 'Party and customer name required' });

      return;

    }

    if (formData.items.some(item => !item.name || item.quantity <= 0 || item.rate <= 0)) {

      setStatus({ type: 'error', message: 'All items must be valid' });

      return;

    }



    setLoading(true);

    setStatus({ type: '', message: '' });



    try {

      const response = await fetch(`${serverUrl}/create-voucher`, {

        method: 'POST',

        headers: { 'Content-Type': 'application/json' },

        body: JSON.stringify(formData)

      });



      const result = await response.json();

      

      if (result.success === true) {

        const voucherNum = result.voucherNumber || 'Unknown';

        setLastVoucherNumber(voucherNum);

        setStatus({ 

          type: 'success', 

          message: `âœ“ Bill ${voucherNum} created successfully in Tally!` 

        });

        setFormData({

          companyName: formData.companyName,

          partyName: formData.partyName,

          customerName: '',

          address: '',

          phone: '',

          date: new Date().toISOString().split('T')[0],

          items: [{ name: '', imei: '', quantity: 1, rate: 0, gstRate: 18, amount: 0 }]

        });

      } else {

        const errorMsg = result.error || 'Failed to create voucher';

        setStatus({ 

          type: 'error', 

          message: `âœ— ${errorMsg}` 

        });

      }

    } catch (error) {

      setStatus({ type: 'error', message: 'âœ— Cannot connect to server' });

    } finally {

      setLoading(false);

    }

  };



  const totals = calculateTotals();



  return (

    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">

      <div className="max-w-2xl mx-auto">

        <div className="bg-white rounded-lg shadow-lg p-6 mb-4">

          <h1 className="text-2xl font-bold text-gray-800 mb-6">ðŸ›’ Retail Sale Entry</h1>



          <div className="mb-6 p-4 bg-gray-50 rounded-lg">

            <label className="block text-sm font-medium text-gray-700 mb-2">Server URL</label>

            <input

              type="text"

              value={serverUrl}

              onChange={(e) => setServerUrl(e.target.value)}

              className="w-full px-3 py-2 border border-gray-300 rounded-md"

              placeholder="http://192.168.1.100:5000"

            />

            <button

              onClick={fetchCompanies}

              disabled={loadingCompanies}

              className="mt-3 w-full bg-blue-500 text-white py-2 rounded-md disabled:bg-gray-400"

            >

              {loadingCompanies ? 'Loading...' : 'Fetch Companies from Tally'}

            </button>

          </div>



          {companies.length > 0 && (

            <div className="mb-4">

              <label className="block text-sm font-medium text-gray-700 mb-2">Company *</label>

              <select

                value={formData.companyName}

                onChange={(e) => setFormData({ ...formData, companyName: e.target.value })}

                className="w-full px-3 py-2 border border-gray-300 rounded-md"

              >

                {companies.map((company, index) => (

                  <option key={index} value={company}>{company}</option>

                ))}

              </select>

            </div>

          )}



          {status.message && (

            <div className={`mb-4 p-4 rounded-lg ${status.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>

              {status.message}

            </div>

          )}



          <div className="grid grid-cols-2 gap-4 mb-4">

            <div>

              <label className="block text-sm font-medium text-gray-700 mb-2">Party Ledger *</label>

              <select

                value={formData.partyName}

                onChange={(e) => setFormData({ ...formData, partyName: e.target.value })}

                className="w-full px-3 py-2 border border-gray-300 rounded-md"

              >

                <option value="">Select Party Ledger</option>

                {partyLedgers.map((ledger, index) => (

                  <option key={index} value={ledger}>{ledger}</option>

                ))}

              </select>

            </div>

            <div>

              <label className="block text-sm font-medium text-gray-700 mb-2">Customer Name *</label>

              <input

                type="text"

                value={formData.customerName}

                onChange={(e) => setFormData({ ...formData, customerName: e.target.value })}

                className="w-full px-3 py-2 border border-gray-300 rounded-md"

                placeholder="Full name"

              />

            </div>

          </div>



          <div className="grid grid-cols-2 gap-4 mb-4">

            <div>

              <label className="block text-sm font-medium text-gray-700 mb-2">Address</label>

              <input

                type="text"

                value={formData.address}

                onChange={(e) => setFormData({ ...formData, address: e.target.value })}

                className="w-full px-3 py-2 border border-gray-300 rounded-md"

                placeholder="City"

              />

            </div>

            <div>

              <label className="block text-sm font-medium text-gray-700 mb-2">Phone</label>

              <input

                type="tel"

                value={formData.phone}

                onChange={(e) => setFormData({ ...formData, phone: e.target.value })}

                className="w-full px-3 py-2 border border-gray-300 rounded-md"

                placeholder="Mobile"

              />

            </div>

          </div>



          <div className="mb-6">

            <label className="block text-sm font-medium text-gray-700 mb-2">Date</label>

            <input

              type="date"

              value={formData.date}

              onChange={(e) => setFormData({ ...formData, date: e.target.value })}

              className="w-full px-3 py-2 border border-gray-300 rounded-md"

            />

          </div>



          <div className="mb-6">

            <div className="flex justify-between mb-3">

              <label className="text-sm font-medium text-gray-700">Items</label>

              <button onClick={addItem} className="text-sm text-blue-600">+ Add Item</button>

            </div>



            {formData.items.map((item, index) => (

              <div key={index} className="mb-3 p-4 bg-gray-50 rounded-lg">

                <div className="flex justify-between mb-2">

                  <span className="text-sm font-medium">Item {index + 1}</span>

                  {formData.items.length > 1 && (

                    <button onClick={() => removeItem(index)} className="text-red-600 text-sm">Remove</button>

                  )}

                </div>



                <input

                  type="text"

                  list={`stock-items-${index}`}

                  value={item.name}

                  onChange={(e) => updateItem(index, 'name', e.target.value)}

                  className="w-full px-3 py-2 border border-gray-300 rounded-md mb-2"

                  placeholder="Stock item name"

                />

                <datalist id={`stock-items-${index}`}>

                  {stockItems.map((stockItem, idx) => (

                    <option key={idx} value={stockItem} />

                  ))}

                </datalist>



                <input

                  type="text"

                  value={item.imei}

                  onChange={(e) => updateItem(index, 'imei', e.target.value)}

                  className="w-full px-3 py-2 border border-gray-300 rounded-md mb-2"

                  placeholder="IMEI (optional)"

                />



                <div className="grid grid-cols-4 gap-2">

                  <input

                    type="number"

                    value={item.quantity}

                    onChange={(e) => updateItem(index, 'quantity', e.target.value)}

                    className="px-3 py-2 border border-gray-300 rounded-md"

                    placeholder="Qty"

                  />

                  <input

                    type="number"

                    value={item.rate}

                    onChange={(e) => updateItem(index, 'rate', e.target.value)}

                    className="px-3 py-2 border border-gray-300 rounded-md"

                    placeholder="Rate"

                  />

                  <select

                    value={item.gstRate}

                    onChange={(e) => updateItem(index, 'gstRate', e.target.value)}

                    className="px-3 py-2 border border-gray-300 rounded-md"

                  >

                    <option value="0">0%</option>

                    <option value="5">5%</option>

                    <option value="12">12%</option>

                    <option value="18">18%</option>

                    <option value="28">28%</option>

                  </select>

                  <input

                    type="number"

                    value={item.amount.toFixed(2)}

                    readOnly

                    className="px-3 py-2 border bg-gray-100 rounded-md"

                  />

                </div>

              </div>

            ))}

          </div>



          <div className="mb-6 p-4 bg-indigo-50 rounded-lg space-y-2">

            <div className="flex justify-between text-sm">

              <span>Subtotal:</span>

              <span>â‚¹{totals.subtotal.toFixed(2)}</span>

            </div>

            <div className="flex justify-between text-sm">

              <span>CGST:</span>

              <span>â‚¹{totals.cgst.toFixed(2)}</span>

            </div>

            <div className="flex justify-between text-sm">

              <span>SGST:</span>

              <span>â‚¹{totals.sgst.toFixed(2)}</span>

            </div>

            <div className="flex justify-between text-sm">

              <span>Round Off:</span>

              <span>â‚¹{totals.roundOff.toFixed(2)}</span>

            </div>

            <div className="border-t pt-2 flex justify-between font-bold text-lg">

              <span>Total:</span>

              <span className="text-indigo-600">â‚¹{totals.roundedTotal.toFixed(2)}</span>

            </div>

          </div>



          <button

            onClick={handleSubmit}

            disabled={loading}

            className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold disabled:bg-gray-400"

          >

            {loading ? 'Creating...' : 'Create Retail Sale in Tally'}

          </button>

        </div>



        <p className="text-center text-sm text-gray-600">Make sure Tally and server are running</p>

      </div>

    </div>

  );

}



ReactDOM.render(<TallyRetailSaleForm />, document.getElementById('root'));

    </script>

</body>

</html>